<%# Custom Scrollbar Styles %>
<style>
  /* Hide native scrollbar completely - all browsers including mobile */
  html, body {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
    -webkit-overflow-scrolling: touch; /* iOS momentum scrolling */
  }
  html::-webkit-scrollbar,
  body::-webkit-scrollbar,
  *::-webkit-scrollbar {
    width: 0 !important;
    height: 0 !important;
    display: none !important;
    background: transparent !important;
  }
  /* Hide iOS/mobile white scrollbar */
  html::-webkit-scrollbar-track,
  body::-webkit-scrollbar-track,
  *::-webkit-scrollbar-track {
    display: none !important;
    background: transparent !important;
  }
  html::-webkit-scrollbar-thumb,
  body::-webkit-scrollbar-thumb,
  *::-webkit-scrollbar-thumb {
    display: none !important;
    background: transparent !important;
  }
  
  /* Custom scrollbar overlay */
  .custom-scrollbar {
    position: fixed;
    right: 0;
    top: 0;
    width: 8px;
    height: 100vh;
    z-index: 9999;
    pointer-events: none;
  }
  .custom-scrollbar-thumb {
    position: absolute;
    right: 0;
    width: 8px;
    background: rgba(89, 94, 71, 0.4);
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  .custom-scrollbar:hover .custom-scrollbar-thumb,
  .custom-scrollbar-thumb:hover {
    background: rgba(89, 94, 71, 0.6);
    pointer-events: auto;
  }
</style>

<%# Custom scrollbar element %>
<div class="custom-scrollbar" id="customScrollbar">
  <div class="custom-scrollbar-thumb" id="customScrollbarThumb"></div>
</div>

<nav id="mainNavbar" class="navbar navbar-light py-3" style="background-color: transparent; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; transition: transform 0.3s ease;">
  <div class="container-fluid px-4">
    <%= link_to root_path, class: "navbar-brand d-flex align-items-center gap-2" do %>
      <%= image_tag "logo.png", class: "rounded-circle logo-responsive", width: 40, height: 40, alt: "Festival logo" %>
      <span id="festivalText" class="fw-bold fs-4 text-primary" style="<%= 'display: none;' if current_page?(root_path) %> transition: opacity 0.3s ease, transform 0.3s ease, width 0.3s ease; overflow: hidden; white-space: nowrap;">Festival</span>
    <% end %>
  </div>
</nav>

<%# Hamburger Menu Button - Outside nav, always on top %>
<button id="mobileMenuBtn" class="hamburger-responsive" style="background-color: #ede4de; border: none; padding: 12px; cursor: pointer; width: 50px; height: 50px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; position: fixed; right: 20px; top: 20px; z-index: 10000; transition: transform 0.3s ease;">
  <span id="menuLine1" class="hamburger-line" style="display: block; width: 24px; height: 2px; background-color: #595E47; border-radius: 2px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);"></span>
  <span id="menuLine2" class="hamburger-line" style="display: block; width: 24px; height: 2px; background-color: #595E47; border-radius: 2px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);"></span>
  <span id="menuLine3" class="hamburger-line" style="display: block; width: 24px; height: 2px; background-color: #595E47; border-radius: 2px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);"></span>
</button>

<%# Mobile Fullscreen Menu %>
<div id="mobileMenuOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: white; z-index: 9998; overflow-y: auto; opacity: 0; transition: opacity 0.4s ease-in-out;">
  <div class="container py-4">
    <%# Empty header space to maintain layout consistency %>
    <div class="mb-5" style="height: 50px;"></div>

    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 60vh;">
      <ul class="list-unstyled text-center mb-5" id="menuItems">
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Accueil', root_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Le Programme', offres_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Les Animateur.ices', fournisseurs_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Le 47', lieu_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
      </ul>

      <div class="text-center mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;" id="menuCTA">
        <%= link_to "Je viens !", participation_path, class: 'btn btn-lg mb-3', style: 'background-color: #7B8467; color: white; border: none; transition: transform 0.3s ease, box-shadow 0.3s ease;' %>
        <div>
          <%= link_to "Je ne peux pas venir mais je soutiens!", "https://opencollective.com/le-47/contribute/contribution-financiere-77696/checkout?interval=month&amount=50&contributeAs=me", class: 'text-decoration-none d-block', style: 'font-size: 0.9rem; color: #595E47; transition: color 0.3s ease;', target: :blank %>
        </div>
      </div>

      <% if user_signed_in? %>
        <div class="text-center mt-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;" id="menuAccount">
          <%= link_to dashboard_path, class: 'btn btn-primary btn-lg mb-3', style: 'transition: transform 0.3s ease, box-shadow 0.3s ease;' do %>
            <i class="bi bi-person-circle me-2"></i>
            <span>Mon compte festivalier</span>
          <% end %>
          
          <% if current_user.admin? %>
            <div class="mt-3">
              <button id="cms-edit-toggle" class="btn <%= session[:edit_mode] ? 'btn-warning active' : 'btn-outline-secondary' %> btn-lg" title="Toggle edit mode" type="button">
                <i class="fa fa-pen me-2"></i>
                Mode Ã©dition
              </button>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center mt-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;" id="menuAccount">
          <%= link_to "Se connecter", new_user_session_path, class: 'btn btn-lg', style: 'background-color: #7B8467; color: white; border: none; transition: transform 0.3s ease, box-shadow 0.3s ease;' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function initNavbar() {
    const menuBtn = document.getElementById('mobileMenuBtn');
    const menuOverlay = document.getElementById('mobileMenuOverlay');
    const menuItems = document.querySelectorAll('#menuItems li, #menuCTA, #menuAccount');
    const line1 = document.getElementById('menuLine1');
    const line2 = document.getElementById('menuLine2');
    const line3 = document.getElementById('menuLine3');
    const festivalText = document.getElementById('festivalText');
    const mainNavbar = document.getElementById('mainNavbar');
    
    // Check if we're on the homepage
    const isHomePage = <%= current_page?(root_path) ? 'true' : 'false' %>;
    
    let lastScrollY = window.scrollY;
    let ticking = false;
    let menuOpen = false;

    // Check if device is mobile (viewport width)
    function isMobile() {
      return window.innerWidth < 768; // Bootstrap's md breakpoint
    }

    // Handle scroll for navbar visibility on mobile and Festival text
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          const currentScrollY = window.scrollY;
          
          // Handle Festival text visibility (all devices, but not on homepage)
          if (!isHomePage && festivalText) {
            if (currentScrollY === 0) {
              festivalText.style.opacity = '1';
              festivalText.style.transform = 'translateX(0)';
              festivalText.style.width = 'auto';
            } else {
              festivalText.style.opacity = '0';
              festivalText.style.transform = 'translateX(-20px)';
              festivalText.style.width = '0';
            }
          }

          // Handle navbar auto-hide on mobile only
          if (isMobile()) {
            if (currentScrollY === 0) {
              // At the top - show navbar
              mainNavbar.style.transform = 'translateY(0)';
              menuBtn.style.transform = 'translateY(0)';
            } else if (currentScrollY < lastScrollY) {
              // Scrolling up - show navbar
              mainNavbar.style.transform = 'translateY(0)';
              menuBtn.style.transform = 'translateY(0)';
            } else if (currentScrollY > lastScrollY && currentScrollY > 100) {
              // Scrolling down and past 100px - hide navbar
              mainNavbar.style.transform = 'translateY(-200px)';
              menuBtn.style.transform = 'translateY(-200px)';
            }
          } else {
            // Desktop - always show navbar
            mainNavbar.style.transform = 'translateY(0)';
            menuBtn.style.transform = 'translateY(0)';
          }

          lastScrollY = currentScrollY;
          ticking = false;
        });
        
        ticking = true;
      }
    });

    // Re-check on window resize
    window.addEventListener('resize', function() {
      if (!isMobile()) {
        mainNavbar.style.transform = 'translateY(0)';
        menuBtn.style.transform = 'translateY(0)';
      }
    });

    function openMenu() {
      menuOpen = true;
      menuOverlay.style.display = 'block';
      setTimeout(() => {
        menuOverlay.style.opacity = '1';
        menuItems.forEach((item, index) => {
          setTimeout(() => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          }, index * 100);
        });
      }, 10);

      // Animate hamburger to X
      line1.style.transform = 'rotate(45deg) translate(5px, 5px)';
      line2.style.opacity = '0';
      line3.style.transform = 'rotate(-45deg) translate(6px, -6px)';
      
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      menuOpen = false;
      menuOverlay.style.opacity = '0';
      menuItems.forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
      });
      
      setTimeout(() => {
        menuOverlay.style.display = 'none';
      }, 400);

      // Animate X back to hamburger
      line1.style.transform = 'none';
      line2.style.opacity = '1';
      line3.style.transform = 'none';
      
      document.body.style.overflow = '';
    }

    menuBtn.addEventListener('click', function() {
      if (menuOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Close menu when clicking on a link
    document.querySelectorAll('#mobileMenuOverlay a').forEach(link => {
      link.addEventListener('click', closeMenu);
    });
  }

  // Custom scrollbar functionality
  function initCustomScrollbar() {
    const thumb = document.getElementById('customScrollbarThumb');
    if (!thumb) return;
    
    function updateScrollbar() {
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollTop = window.scrollY;
      
      // Calculate thumb size (proportional but smaller - 60% of normal proportion)
      const proportion = (clientHeight / scrollHeight) * 0.6;
      const thumbHeight = Math.max(proportion * clientHeight, 40);
      // Calculate thumb position
      const maxScroll = scrollHeight - clientHeight;
      const thumbTop = maxScroll > 0 ? (scrollTop / maxScroll) * (clientHeight - thumbHeight) : 0;
      
      thumb.style.height = thumbHeight + 'px';
      thumb.style.top = thumbTop + 'px';
    }
    
    window.addEventListener('scroll', updateScrollbar);
    window.addEventListener('resize', updateScrollbar);
    updateScrollbar();
  }

  // Initialize on both regular page load and Turbo navigation
  document.addEventListener('DOMContentLoaded', function() {
    initNavbar();
    initCustomScrollbar();
  });
  document.addEventListener('turbo:load', function() {
    initNavbar();
    initCustomScrollbar();
  });
</script>
