<nav id="mainNavbar" class="navbar navbar-light py-3" style="background-color: transparent; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; transition: transform 0.3s ease;">
  <div class="container-fluid px-4">
    <%= link_to root_path, class: "navbar-brand d-flex align-items-center gap-2" do %>
      <%= image_tag "logo.png", class: "rounded-circle", width: 40, height: 40, alt: "Festival logo" %>
      <span id="festivalText" class="fw-bold fs-4 text-primary" style="<%= 'display: none;' if current_page?(root_path) %> transition: opacity 0.3s ease, transform 0.3s ease, width 0.3s ease; overflow: hidden; white-space: nowrap;">Festival</span>
    <% end %>

    <%# Hamburger Menu Button - Always visible on the right %>
    <button id="mobileMenuBtn" style="background-color: #ede4de; border: none; padding: 12px; cursor: pointer; width: 50px; height: 50px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; position: fixed; right: 20px; top: 20px; z-index: 1001; transition: transform 0.3s ease;">
      <span id="menuLine1" style="display: block; width: 24px; height: 2px; background-color: #595E47; border-radius: 2px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);"></span>
      <span id="menuLine2" style="display: block; width: 24px; height: 2px; background-color: #595E47; border-radius: 2px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);"></span>
      <span id="menuLine3" style="display: block; width: 24px; height: 2px; background-color: #595E47; border-radius: 2px; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);"></span>
    </button>
  </div>
</nav>

<%# Mobile Fullscreen Menu %>
<div id="mobileMenuOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: white; z-index: 9999; overflow-y: auto; opacity: 0; transition: opacity 0.4s ease-in-out;">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <%= link_to root_path, class: "navbar-brand d-flex align-items-center" do %>
        <%= image_tag "logo.png", class: "rounded-circle me-2", width: 40, height: 40, alt: "Festival logo" %>
        <span class="fw-bold fs-4 text-primary">Festival</span>
      <% end %>
      
      <button id="mobileMenuClose" style="background: none; border: none; font-size: 2.5rem; padding: 0; cursor: pointer; color: #595E47; line-height: 1; transition: transform 0.3s ease, opacity 0.3s ease;" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0deg)'">&times;</button>
    </div>

    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 60vh;">
      <ul class="list-unstyled text-center mb-5" id="menuItems">
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Le Programme', offres_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Les Animateurs', fournisseurs_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
        <li class="mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;">
          <%= link_to 'Le 47', lieu_path, class: 'text-decoration-none fs-3 fw-medium', style: 'color: #595E47; transition: color 0.3s ease;' %>
        </li>
      </ul>

      <div class="text-center mb-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;" id="menuCTA">
        <%= link_to "Je viens", participation_path, class: 'btn btn-lg mb-3', style: 'background-color: #7B8467; color: white; border: none; transition: transform 0.3s ease, box-shadow 0.3s ease;' %>
        <div>
          <%= link_to "Je ne peux pas venir mais je soutiens!", "https://opencollective.com/le-47/contribute/contribution-financiere-77696/checkout?interval=month&amount=50&contributeAs=me", class: 'text-decoration-none d-block', style: 'font-size: 0.9rem; color: #595E47; transition: color 0.3s ease;', target: :blank %>
        </div>
      </div>

      <% if user_signed_in? %>
        <div class="text-center mt-4" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease;" id="menuAccount">
          <%= link_to dashboard_path, class: 'btn btn-primary btn-lg mb-3', style: 'transition: transform 0.3s ease, box-shadow 0.3s ease;' do %>
            <i class="bi bi-person-circle me-2"></i>
            <span>Mon compte festivalier</span>
          <% end %>
          
          <% if current_user.admin? %>
            <div class="mt-3">
              <button id="cms-edit-toggle" class="btn <%= session[:edit_mode] ? 'btn-warning active' : 'btn-outline-secondary' %> btn-lg" title="Toggle edit mode" type="button">
                <i class="fa fa-pen me-2"></i>
                Mode Ã©dition
              </button>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuBtn = document.getElementById('mobileMenuBtn');
    const menuOverlay = document.getElementById('mobileMenuOverlay');
    const menuClose = document.getElementById('mobileMenuClose');
    const menuItems = document.querySelectorAll('#menuItems li, #menuCTA, #menuAccount');
    const line1 = document.getElementById('menuLine1');
    const line2 = document.getElementById('menuLine2');
    const line3 = document.getElementById('menuLine3');
    const festivalText = document.getElementById('festivalText');
    const mainNavbar = document.getElementById('mainNavbar');
    
    // Check if we're on the homepage
    const isHomePage = <%= current_page?(root_path) ? 'true' : 'false' %>;
    
    let lastScrollY = window.scrollY;
    let ticking = false;

    // Check if device is mobile (viewport width)
    function isMobile() {
      return window.innerWidth < 768; // Bootstrap's md breakpoint
    }

    // Handle scroll for navbar visibility on mobile and Festival text
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          const currentScrollY = window.scrollY;
          
          // Handle Festival text visibility (all devices, but not on homepage)
          if (!isHomePage && festivalText) {
            if (currentScrollY === 0) {
              festivalText.style.opacity = '1';
              festivalText.style.transform = 'translateX(0)';
              festivalText.style.width = 'auto';
            } else {
              festivalText.style.opacity = '0';
              festivalText.style.transform = 'translateX(-20px)';
              festivalText.style.width = '0';
            }
          }

          // Handle navbar auto-hide on mobile only
          if (isMobile()) {
            if (currentScrollY === 0) {
              // At the top - show navbar
              mainNavbar.style.transform = 'translateY(0)';
              menuBtn.style.transform = 'translateY(0)';
            } else if (currentScrollY < lastScrollY) {
              // Scrolling up - show navbar
              mainNavbar.style.transform = 'translateY(0)';
              menuBtn.style.transform = 'translateY(0)';
            } else if (currentScrollY > lastScrollY && currentScrollY > 100) {
              // Scrolling down and past 100px - hide navbar
              mainNavbar.style.transform = 'translateY(-100%)';
              menuBtn.style.transform = 'translateY(-100px)';
            }
          } else {
            // Desktop - always show navbar
            mainNavbar.style.transform = 'translateY(0)';
            menuBtn.style.transform = 'translateY(0)';
          }

          lastScrollY = currentScrollY;
          ticking = false;
        });
        
        ticking = true;
      }
    });

    // Re-check on window resize
    window.addEventListener('resize', function() {
      if (!isMobile()) {
        mainNavbar.style.transform = 'translateY(0)';
        menuBtn.style.transform = 'translateY(0)';
      }
    });

    function openMenu() {
      menuOverlay.style.display = 'block';
      setTimeout(() => {
        menuOverlay.style.opacity = '1';
        menuItems.forEach((item, index) => {
          setTimeout(() => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          }, index * 100);
        });
      }, 10);

      // Animate hamburger to X
      line1.style.transform = 'rotate(45deg) translate(5px, 5px)';
      line2.style.opacity = '0';
      line3.style.transform = 'rotate(-45deg) translate(6px, -6px)';
      
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      menuOverlay.style.opacity = '0';
      menuItems.forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
      });
      
      setTimeout(() => {
        menuOverlay.style.display = 'none';
      }, 400);

      // Animate X back to hamburger
      line1.style.transform = 'none';
      line2.style.opacity = '1';
      line3.style.transform = 'none';
      
      document.body.style.overflow = '';
    }

    menuBtn.addEventListener('click', function() {
      if (menuOverlay.style.display === 'none' || menuOverlay.style.display === '') {
        openMenu();
      } else {
        closeMenu();
      }
    });

    menuClose.addEventListener('click', closeMenu);

    // Close menu when clicking on a link
    document.querySelectorAll('#mobileMenuOverlay a').forEach(link => {
      link.addEventListener('click', closeMenu);
    });
  });
</script>
