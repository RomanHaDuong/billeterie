<div class="container py-5">
  <div class="card border-0 shadow-sm">
    <div class="card-body p-4">
      <%= form_with(model: @offre, local: true, class: "needs-validation") do |f| %>
        <% if @offre.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@offre.errors.count, "erreur") %> ont empêché la sauvegarde:</h4>
            <ul>
              <% @offre.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="row g-4">
          <%# Titre %>
          <div class="col-md-8">
            <%= f.label :titre, class: "form-label fw-bold" do %>
              Titre de l'atelier <span class="text-danger">*</span>
            <% end %>
            <%= f.text_field :titre, class: "form-control form-control-lg", placeholder: "Ex: Atelier de méditation", required: true %>
          </div>

          <%# Date %>
          <div class="col-md-4">
            <%= f.label :date_prevue, class: "form-label fw-bold" do %>
              Date et heure <span class="text-danger">*</span>
            <% end %>
            <%= f.datetime_local_field :date_prevue, class: "form-control", required: true %>
          </div>

          <%# Sous-titre %>
          <div class="col-12">
            <%= f.label :sous_titre, "Sous-titre", class: "form-label fw-bold" %>
            <%= f.text_field :sous_titre, class: "form-control", placeholder: "Courte description accrocheuse" %>
          </div>

          <%# Description %>
          <div class="col-12">
            <%= f.label :descriptif, class: "form-label fw-bold" do %>
              Description complète <span class="text-danger">*</span>
            <% end %>
            <%= f.text_area :descriptif, class: "form-control", rows: 5, placeholder: "Décrivez votre atelier en détail...", required: true %>
          </div>

          <%# Image %>
          <div class="col-12">
            <%= f.label :image, "Image de l'atelier", class: "form-label fw-bold" %>
            <%= f.file_field :image, class: "form-control", accept: "image/*" %>
            <% if @offre.image.attached? %>
              <div class="mt-2">
                <%= image_tag @offre.image, class: "img-thumbnail", style: "max-width: 200px;" %>
              </div>
            <% end %>
          </div>

          <%# Durée et Places %>
          <div class="col-md-6">
            <%= f.label :duree, "Durée", class: "form-label fw-bold" %>
            <%= f.text_field :duree, class: "form-control", placeholder: "Ex: 1h30" %>
          </div>

          <div class="col-md-6">
            <%= f.label :place, class: "form-label fw-bold" do %>
              Nombre de places <span class="text-danger">*</span>
            <% end %>
            <%= f.number_field :place, class: "form-control", min: 1, placeholder: "Ex: 20", required: true %>
          </div>

          <%# Salle et Catégories %>
          <div class="col-md-6">
            <%= f.label :salle, "Salle/Lieu", class: "form-label fw-bold" %>
            <%= f.text_field :salle, class: "form-control", placeholder: "Ex: Salle A, Rez-de-chaussée" %>
          </div>

          <div class="col-md-6">
            <%= f.label :categories, "Catégories", class: "form-label fw-bold" %>
            <%= f.text_field :categories, class: "form-control", placeholder: "Ex: Bien-être, Créativité" %>
          </div>

          <%# Causes et Valeur apportée %>
          <div class="col-md-6">
            <%= f.label :causes, "Causes/Thèmes abordés", class: "form-label fw-bold" %>
            <%= f.text_area :causes, class: "form-control", rows: 3, placeholder: "Quelles causes ou thèmes votre atelier aborde-t-il ?" %>
          </div>

          <div class="col-md-6">
            <%= f.label :valeur_apportee, "Valeur apportée", class: "form-label fw-bold" %>
            <%= f.text_area :valeur_apportee, class: "form-control", rows: 3, placeholder: "Qu'est-ce que les participants vont apprendre ou gagner ?" %>
          </div>

          <%# Besoins %>
          <div class="col-md-6">
            <%= f.label :besoin_espace, "Besoins d'espace", class: "form-label fw-bold" %>
            <%= f.text_area :besoin_espace, class: "form-control", rows: 3, placeholder: "Quel type d'espace nécessitez-vous ?" %>
          </div>

          <div class="col-md-6">
            <%= f.label :besoin_logistique, "Besoins logistiques", class: "form-label fw-bold" %>
            <%= f.text_area :besoin_logistique, class: "form-control", rows: 3, placeholder: "Matériel, équipement nécessaire..." %>
          </div>

          <%# Option pour plusieurs intervenants %>
          <div class="col-12">
            <div class="form-check">
              <%= check_box_tag :multiple_intervenants, '1', @offre.additional_fournisseurs.any?, 
                  class: "form-check-input", 
                  id: "multiple_intervenants_checkbox" %>
              <%= label_tag :multiple_intervenants, "Il y aura plusieurs intervenants", class: "form-check-label fw-bold" %>
            </div>
          </div>

          <%# Intervenants supplémentaires %>
          <div class="col-12" id="additional_fournisseurs_section" style="<%= 'display: none;' unless @offre.additional_fournisseurs.any? %>">
            <%= f.label :additional_fournisseur_ids, "Intervenants supplémentaires (co-intervenants)", class: "form-label fw-bold" %>
            <%= f.collection_check_boxes :additional_fournisseur_ids, 
                Fournisseur.all.where.not(id: @offre.fournisseur_id), 
                :id, :name do |b| %>
              <div class="form-check">
                <%= b.check_box class: "form-check-input" %>
                <%= b.label class: "form-check-label" %>
              </div>
            <% end %>
          </div>

          <%# Autres commentaires %>
          <div class="col-12">
            <%= f.label :autre_commentaire, "Autres commentaires", class: "form-label fw-bold" %>
            <%= f.text_area :autre_commentaire, class: "form-control", rows: 3, placeholder: "Informations complémentaires..." %>
          </div>

          <%# Submit buttons %>
          <div class="col-12">
            <div class="d-flex gap-3 justify-content-between align-items-center">
              <% if @offre.persisted? %>
                <%= link_to "Supprimer", offre_path(@offre), 
                    method: :delete, 
                    class: "btn btn-danger", 
                    data: { 
                      turbo_method: :delete,
                      turbo_confirm: "Êtes-vous sûr de vouloir supprimer cet atelier ? Cette action est irréversible." 
                    } %>
              <% end %>
              <div class="d-flex gap-3">
                <%= link_to "Annuler", @offre.persisted? ? offre_path(@offre) : dashboard_path, class: "btn btn-outline-secondary" %>
                <%= f.submit @offre.persisted? ? "Mettre à jour l'atelier" : "Créer l'atelier", class: "btn btn-primary btn-lg" %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function initializeMultipleIntervenantsToggle() {
    const checkbox = document.getElementById('multiple_intervenants_checkbox');
    const section = document.getElementById('additional_fournisseurs_section');
    
    if (checkbox && section) {
      // Remove existing listener if any to avoid duplicates
      checkbox.replaceWith(checkbox.cloneNode(true));
      const freshCheckbox = document.getElementById('multiple_intervenants_checkbox');
      
      freshCheckbox.addEventListener('change', function() {
        if (this.checked) {
          section.style.display = 'block';
        } else {
          section.style.display = 'none';
          // Uncheck all co-intervenant checkboxes when hiding the section
          const coIntervenantCheckboxes = section.querySelectorAll('input[type="checkbox"]');
          coIntervenantCheckboxes.forEach(cb => cb.checked = false);
        }
      });
    }
  }

  // Initialize on both DOMContentLoaded and turbo:load
  document.addEventListener('DOMContentLoaded', initializeMultipleIntervenantsToggle);
  document.addEventListener('turbo:load', initializeMultipleIntervenantsToggle);
  
  // Also initialize immediately in case the script loads after DOM is ready
  if (document.readyState === 'loading') {
    // DOM is still loading
  } else {
    // DOM is already loaded, initialize immediately
    initializeMultipleIntervenantsToggle();
  }
</script>
