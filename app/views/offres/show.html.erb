<div class="container py-5">
  <%# Title and Edit Button %>
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="fw-bold mb-2"><%= @offre.titre %></h1>
      <p class="text-muted mb-0"><%= @offre.sous_titre %></p>
    </div>
    <% if @is_owner || current_user&.admin? %>
      <%= link_to edit_offre_path(@offre), class: "btn btn-outline-primary" do %>
        <i class="fa-solid fa-edit me-2"></i>Modifier
      <% end %>
    <% end %>
  </div>

  <%# Image - Mobile only (below title) %>
  <div class="d-lg-none mb-4">
    <div class="workshop-show-img-wrapper rounded-3 overflow-hidden shadow-sm">
      <% if @offre.image.attached? %>
        <%= image_tag @offre.image, class: "w-100", style: "aspect-ratio: 1; object-fit: cover;" %>
      <% else %>
        <%= image_tag "placeholder_offre.png", class: "w-100", style: "aspect-ratio: 1; object-fit: cover;" %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <%# Left Column on Desktop %>
    <div class="col-lg-8 mb-4">
      <%# Description - Order 2 on mobile %>
      <div class="card border-0 shadow-sm p-4 mb-4">
        <h5 class="fw-bold mb-3">Description de l'animation</h5>
        <p class="mb-0"><%= @offre.descriptif %></p>
      </div>

      <%# Registration Section - Order 3 on mobile %>
      <div class="card border-0 shadow-sm p-4 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
          <div>
            <h5 class="fw-bold mb-2">Inscription à l'atelier</h5>
            <% if @offre.place %>
              <p class="mb-0 text-muted">
                <i class="fa-solid fa-users me-2"></i>
                <%= @offre.bookings.count %> / <%= @offre.place %> places occupées
                <% if @offre.available_spots && @offre.available_spots > 0 %>
                  <span class="badge <%= @offre.available_spots > 5 ? 'bg-success' : 'bg-warning' %> ms-2">
                    <%= @offre.available_spots %> place<%= @offre.available_spots > 1 ? 's' : '' %> restante<%= @offre.available_spots > 1 ? 's' : '' %>
                  </span>
                <% elsif @offre.full? %>
                  <span class="badge bg-danger ms-2">
                    Complet - Plus de places
                  </span>
                <% end %>
              </p>
            <% end %>
          </div>
          <div>
            <% if current_user %>
              <% if @offre.user_registered?(current_user) %>
                <%= button_to "Se désinscrire", unregister_offre_path(@offre), method: :delete, class: "btn btn-outline-danger", data: { confirm: "Êtes-vous sûr de vouloir vous désinscrire ?" } %>
              <% elsif @offre.full? %>
                <button class="btn btn-secondary" disabled>Complet</button>
              <% else %>
                <%= button_to "S'inscrire", register_offre_path(@offre), method: :post, class: "btn", style: "background-color: #7B8467; color: white; border: none;" %>
              <% end %>
            <% else %>
              <%= link_to "S'inscrire", new_user_registration_path(return_to: request.fullpath), class: "btn", style: "background-color: #7B8467; color: white; border: none;" %>
            <% end %>
          </div>
        </div>

        <% if current_user && @offre.bookings.any? %>
          <%# Show registered users %>
          <hr class="my-3">
          <h6 class="fw-bold mb-3">Participants inscrits</h6>
          <div class="d-flex flex-wrap gap-2">
            <% @offre.registered_users.includes(:image_attachment).each do |user| %>
              <div class="position-relative" data-bs-toggle="tooltip" title="<%= user.name || user.email %>">
                <% if user.image.attached? %>
                  <%= image_tag user.image, class: "rounded-circle border border-2 border-white shadow-sm", style: "width: 40px; height: 40px; object-fit: cover;" %>
                <% else %>
                  <%= image_tag "placeholder_person.png", class: "rounded-circle border border-2 border-white shadow-sm", style: "width: 40px; height: 40px; object-fit: cover;" %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Intervenant Info - Order 4 on mobile %>
      <%= link_to fournisseur_path(@offre.fournisseur), class: "text-decoration-none" do %>
        <div class="card border-0 shadow-sm p-4 mb-4 intervenant-card">
          <div class="d-flex align-items-center mb-3">
            <% if @offre.fournisseur.user&.image&.attached? %>
              <%= image_tag @offre.fournisseur.user.image, class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
            <% elsif @offre.fournisseur.image.attached? %>
              <%= image_tag @offre.fournisseur.image, class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
            <% else %>
              <%= image_tag "placeholder_person.png", class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
            <% end %>
            <div>
              <h5 class="mb-0 fw-bold text-dark"><%= @offre.fournisseur.name %></h5>
              <p class="mb-0 text-muted">Animateur-ice</p>
            </div>
          </div>
          <p class="mb-0 text-dark"><%= @offre.fournisseur.bio %></p>
        </div>
      <% end %>

      <%# 2nd intervenant info %>
      <% if @offre.secondary_fournisseur %>
        <%= link_to fournisseur_path(@offre.secondary_fournisseur), class: "text-decoration-none" do %>
          <div class="card border-0 shadow-sm p-4 mb-4 intervenant-card">
            <div class="d-flex align-items-center mb-3">
              <% if @offre.secondary_fournisseur.user&.image&.attached? %>
                <%= image_tag @offre.secondary_fournisseur.user.image, class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
              <% elsif @offre.secondary_fournisseur.image.attached? %>
                <%= image_tag @offre.secondary_fournisseur.image, class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
              <% else %>
                <%= image_tag "placeholder_person.png", class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
              <% end %>
              <div>
                <h5 class="mb-0 fw-bold text-dark"><%= @offre.secondary_fournisseur.name %></h5>
                <p class="mb-0 text-muted">Animateur-ice</p>
              </div>
            </div>
            <p class="mb-0 text-dark"><%= @offre.secondary_fournisseur.bio %></p>
          </div>
        <% end %>
      <% end %>

      <%# Additional intervenants (3-5) %>
      <% @offre.additional_fournisseurs.each do |fournisseur| %>
        <%= link_to fournisseur_path(fournisseur), class: "text-decoration-none" do %>
          <div class="card border-0 shadow-sm p-4 mb-4 intervenant-card">
            <div class="d-flex align-items-center mb-3">
              <% if fournisseur.user&.image&.attached? %>
                <%= image_tag fournisseur.user.image, class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
              <% elsif fournisseur.image.attached? %>
                <%= image_tag fournisseur.image, class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
              <% else %>
                <%= image_tag "placeholder_person.png", class: "rounded-circle me-3", style: "width: 48px; height: 48px; object-fit: cover;" %>
              <% end %>
              <div>
                <h5 class="mb-0 fw-bold text-dark"><%= fournisseur.name %></h5>
                <p class="mb-0 text-muted">Animateur-ice</p>
              </div>
            </div>
            <p class="mb-0 text-dark"><%= fournisseur.bio %></p>
          </div>
        <% end %>
      <% end %>
    </div>

    <%# Right Column on Desktop - Shows image then info pratiques %>
    <div class="col-lg-4">
      <%# Image - Desktop only (above informations pratiques) %>
      <div class="rounded-3 shadow-sm mb-4" style="display: none;">
        <% if @offre.image.attached? %>
          <%= image_tag @offre.image, class: "img-fluid rounded-3", style: "width: 100%; height: auto; display: block;" %>
        <% else %>
          <%= image_tag "placeholder_offre.png", class: "img-fluid rounded-3", style: "width: 100%; height: auto; display: block;" %>
        <% end %>
      </div>

      <style>
        @media (min-width: 992px) {
          .col-lg-4 > div:first-child {
            display: block !important;
          }
        }
      </style>
      
      <%# Informations pratiques - Order 5 on mobile %>
      <div class="card border-0 shadow-sm p-4">
        <h5 class="fw-bold mb-3">Informations pratiques</h5>
        <div class="row g-3">
          <div class="col-12">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-calendar text-primary me-2"></i>
              <span><%= l(@offre.date_prevue.beginning_of_day, format: :long) %>, <%= format_time_french(@offre.date_prevue) %></span>
            </div>
          </div>
          <div class="col-12">
            <div class="d-flex align-items-center">
              <i class="fa-regular fa-clock text-primary me-2"></i>
              <span><%= @offre.duree %></span>
            </div>
          </div>
          <div class="col-12">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-location-dot text-primary me-2"></i>
              <span><%= @offre.salle %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>
